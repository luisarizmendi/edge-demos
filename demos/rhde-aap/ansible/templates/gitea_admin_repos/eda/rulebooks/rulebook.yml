---
{% raw %}
- name: Listen for events on a webhook
  hosts: all

  sources:
    - ansible.eda.webhook:
        host: 0.0.0.0
        port: 8445

  rules:
    - name: Trigger provisioning workflow
      condition: event.payload.ip_address is defined and event.payload.mac_address is defined and event.payload.student is defined

      action:
        run_playbook:
          name: run-workflow-provision-device.yml
          extra_vars:
            ip_address: "{{ event.payload.ip_address }}"
            student: "{{ event.payload.student }}"
            mac_address: "{{ event.payload.mac_address }}"


    - name: Create new device image
      condition: "'production-image-definition.yml' in event.payload.commits[0].modified"
      action:
        run_playbook:
          name: run-workflow-create-device-image.yml
          extra_vars:
            username: "{{ event.payload.repository.owner.login | capitalize }}"

    - name: Publish new device image
      condition: "('production-image-deploy.yml' in event.payload.commits[0].modified or 'production-kickstart.ks' in event.payload.commits[0].modified) and 'production-image-definition.yml' not in event.payload.commits[0].modified "
      action:
        run_playbook:
          name: run-task-publish-device-image.yml
          extra_vars:
            username: "{{ event.payload.repository.owner.login | capitalize }}"


{% endraw %}