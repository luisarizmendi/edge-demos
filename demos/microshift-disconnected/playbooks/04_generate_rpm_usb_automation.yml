---
# Based on https://www.redhat.com/en/blog/how-to-create-a-fully-self-contained-os-image-that-includes-your-kubernetes-workload

- name: Create RPM with usb automation and add it to Image Builder
  hosts: image_builder
  become: true
  gather_facts: true
  vars_files:
  - ../vars/main.yml

  tasks:


########## Generate the keys if they are not created and copy to iles/usb-automation folder



       openssl genpkey -algorithm RSA -out rhde-automation-priv.pem
       openssl rsa -pubout -in rhde-automation-priv.pem -out rhde-automation-pub.pem



COPY PUB (con permisos buenos), and directory



############################


generate key

openssl rand -base64 32 > rhde_automation_encryption_key


encrypt
tar -cf rhde.tar rhde/
openssl enc -aes-256-cbc -salt -in rhde.tar -out rhde_encrypted.tar -pass file:rhde_automation_encryption_key -pbkdf2
rm -f rhde.tar


decrypt
openssl enc -d -aes-256-cbc -in rhde_encrypted.tar -out rhde.tar -pass file:rhde_automation_encryption_key -pbkdf2
tar xvf rhde.tar
rm -f rhde.tar








###########


    - name: Install other dependencies
      ansible.builtin.dnf:
        name: 
          - rpmdevtools
          - rpmlint
          - yum-utils
          - createrepo
        state: latest

    - name: Initiate the rpm build tree
      shell: rpmdev-setuptree

    - name: Copy RPM SPEC
      copy:
        src: ../files/usb-automation.spec
        dest: "~/rpmbuild/SPECS/usb-automation.spec"

    - name: rpm build 
      shell: rpmbuild -bb ~/rpmbuild/SPECS/usb-automation.spec





########### Create RPM and add it to local repo



#### check if it exist and if created in image builder



    # TODO modify permissions to allow only image builder
    - name: create local repo
      shell: |
        createrepo ~/rpmbuild/RPMS/
        chmod a+rx ~

    - name: Create repo-local-rpmbuild.toml
      copy:
        content: |
          id = "local-rpm-build"
          name = "RPMs build locally"
          type = "yum-baseurl"
          url = "file:///root/rpmbuild/RPMS"
          check_gpg = false
          check_ssl = false
          system = false
        dest: "repo-local-rpmbuild.toml"


    - name: Add the local RPM repository to Image Builder sources
      shell: "composer-cli sources add repo-local-rpmbuild.toml"


########### 